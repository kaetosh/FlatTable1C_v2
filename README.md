Программа-генератор сводной таблицы из анализа бухгалтерского счета/оборотов бухгалтерского счета/оборотно-сальдовой ведомости по счету из 1С

Эта программа предназначена для экономистов, аналитиков, бухгалтеров и других специалистов, которые занимаются составлением сводной финансовой и управленческой отчетности по группе компаний. Например, она может быть использована для подготовки сводного отчета о движении денежных средств или отчета по инвестиционным или капитализированным расходам. Программа позволяет объединить анализы счетов из 1С в одну сводную плоскую таблицу, что значительно упрощает дальнейший анализ и подготовку сводных отчетов.

Создание нового файла Excel

После запуска программы в папке с исходными файлами для обработки создается новый файл Excel с двумя листами: сводная таблица и таблица с отклонениями по оборотам до и после обработки. Второй лист служит для проверки правильности интеграции необходимых строк из анализов счетов в итоговый файл.

Тестирование на различных версиях 1С

Программа была протестирована на анализах счетов из 1С:Предприятие 8.3 (Конфигурация "Бухгалтерия предприятия", Конфигурация "Управление производственным предприятием", Конфигурация "1С:ERP Агропромышленный комплекс", Конфигурация "1С:ERP Управление предприятием 2"). Она поддерживает анализы счетов с детализацией по субсчетам и субконто любого уровня вложенности, а также с расшифровкой любых корреспондирующих счетов по субсчетам и субконто первого уровня (не глубже). Например, для составления сводного отчета по инвестициям можно выгрузить анализ 08 счета по каждой компании с детализацией по строящимся объектам и статьям затрат. Корреспондирующие счета могут быть расшифрованы по субсчетам, а счета 60 и 76 — по контрагентам.

Под «капотом» скрипта файлы проходят следующие этапы обработки:

после запуска программы пользователю будет предложено выбрать папку с исходными файлами с анализами счетов в формате .xls/.xlsx;
все обнаруженные в папке файлы пересохраняются в актуальный формат .xlsx текущей версией Excel, установленной на компьютере пользователя (некоторые версии 1С выгружают файлы в устаревшей версии Excel, из-за чего Python не может их корректно обработать);
далее в цикле каждый файл проходит предварительную обработку с помощью библиотеки openpyxl, которая работает непосредственно с excel-файлами, а именно снимается объединение ячеек, удаляются пустые столбцы и строки, устанавливаются два дополнительных столбца: в первом будут указаны номера группировок (по уровням иерархии, в соответствии с «+» и «-» слева на полях рабочего листа excel файла). По этим номерам скрипт далее разнесет данные в «плоский» вид. Второй столбец – признак того, что строка в таблице отформатирована курсивом. Дело в том, что курсивом в выгрузках обозначены дополнительные группировки данных, например, в анализах по счетам расчетов с контрагентами это могут быть монополии, банки, страховые, физ. лица и т.д. Такие позиции также содержат промежуточные итоги, поэтому скрипт их таким образом помечает, чтобы избежать дублирования оборотов в итоговом файле. На этом этапе непосредственная работа с excel-файлами заканчивается, данные из этих предобработанных файлов загружаются в библиотеку pandas, предназначенную для работы с большими табличными данными;
также в цикле в каждой таблице скрипт ищет значение «Счет» и строку, содержащую искомое значение, определяет эту строку как шапку таблицы. Удаляет строки выше шапки таблицы, добавляет столбец с названием файла. В название файла стоит включать идентификатор компании, чтобы в сводном файле разграничивать данные разных компаний;
далее в каждой таблице в столбце с аналитикой скрипт по определенным критериям определяет не заполненные значения (пропущенные субконто или вид субконто), заменяя их значениями «не_заполнено»;
на следующем этапе в строки с самым глубоким уровнем иерархии добавляются значения вышестоящих уровней иерархии, тем самым мы обеспечиваем «плоский» вид таблицы, а также добавляется столбец с корреспондирующими счетами;
на завершающем этапе из таблицы удаляются строки с дубль-оборотами (сальдо на начало/конец, итоговые обороты, обороты по родительским счетам и по счетам, которые расшифрованы по субконто т. д.);
все обработанные таблицы конкатенируются одна под одной с общей шапкой, происходит выравнивание столбцов, чтобы корреспондирующие счета располагались в одном столбце (разные счета имеют субсчета разной глубины);
алгоритмом предусмотрена сверка итоговой суммы по оборотам до обработки таблиц и после для контроля правильности разнесения оборотов в «плоский» вид. Сверка сохраняется на отдельном листе итогового файла.
Общая таблица вместе с таблицей сверки выгружается в excel-файл.
Рекомендации по работе с программой

При работе с программой рекомендуется включать в название файлов идентификатор компании, так как в результирующем файле будет столбец с названием файла, по которому можно идентифицировать каждую компанию в группе.

Уровни иерархии

Важно отметить, что выгруженные в файлы Excel анализы счетов должны содержать уровни иерархии (группировки строк, которые скрываются/отображаются с помощью кнопок + и – слева в полях). По этим уровням программа будет разворачивать вложенные данные в плоский вид таблицы. Поэтому анализы счетов следует выгружать через меню "Сохранить как" в 1С.

Запуск программы

Перед запуском программы убедитесь, что нет открытых файлов Excel.

Ошибки и улучшения

Обратите внимание, что алгоритм скрипта не может учесть все особенности различных вариаций выгрузок анализов счетов из 1С, что может привести к ошибкам в работе программы. Если вы столкнулись с какими-либо ошибками или хотите предложить улучшения, пожалуйста, отправьте информацию об ошибках (вместе с образцами выгрузок анализов из 1С, которые не были корректно обработаны программой) или предложения по улучшению по контакту в телеграм @kaetosh.

Создание .exe файла с помощью pyinstaller

используйте команду: pyinstaller --onefile --collect-all pyfiglet --icon=icon.ico main.py
